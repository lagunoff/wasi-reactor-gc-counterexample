(()=>{"use strict";class e{static read_bytes(t,r){let s=new e;return s.buf=t.getUint32(r,!0),s.buf_len=t.getUint32(r+4,!0),s}static read_bytes_array(t,r,s){let n=[];for(let i=0;i<s;i++)n.push(e.read_bytes(t,r+8*i));return n}}class t{static read_bytes(e,r){let s=new t;return s.buf=e.getUint32(r,!0),s.buf_len=e.getUint32(r+4,!0),s}static read_bytes_array(e,r,s){let n=[];for(let i=0;i<s;i++)n.push(t.read_bytes(e,r+8*i));return n}}class r{write_bytes(e,t){e.setUint8(t,this.fs_filetype),e.setUint16(t+2,this.fs_flags,!0),e.setBigUint64(t+8,this.fs_rights_base,!0),e.setBigUint64(t+16,this.fs_rights_inherited,!0)}constructor(e,t){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=e,this.fs_flags=t}}class s{write_bytes(e,t){e.setBigUint64(t,this.dev,!0),e.setBigUint64(t+8,this.ino,!0),e.setUint8(t+16,this.filetype),e.setBigUint64(t+24,this.nlink,!0),e.setBigUint64(t+32,this.size,!0),e.setBigUint64(t+38,this.atim,!0),e.setBigUint64(t+46,this.mtim,!0),e.setBigUint64(t+52,this.ctim,!0)}constructor(e,t){this.dev=0n,this.ino=0n,this.nlink=0n,this.atim=0n,this.mtim=0n,this.ctim=0n,this.filetype=e,this.size=t}}class n{fd_advise(e,t,r){return-1}fd_allocate(e,t){return-1}fd_close(){return 0}fd_datasync(){return-1}fd_fdstat_get(){return{ret:-1,fdstat:null}}fd_fdstat_set_flags(e){return-1}fd_fdstat_set_rights(e,t){return-1}fd_filestat_get(){return{ret:-1,filestat:null}}fd_filestat_set_size(e){return-1}fd_filestat_set_times(e,t,r){return-1}fd_pread(e,t,r){return{ret:-1,nread:0}}fd_prestat_get(){return{ret:-1,prestat:null}}fd_prestat_dir_name(e,t){return{ret:-1,prestat_dir_name:null}}fd_pwrite(e,t,r){return{ret:-1,nwritten:0}}fd_read(e,t){return{ret:-1,nread:0}}fd_readdir_single(e){return{ret:-1,dirent:null}}fd_seek(e,t){return{ret:-1,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:-1,offset:0n}}fd_write(e,t){return{ret:-1,nwritten:0}}path_create_directory(e){return-1}path_filestat_get(e,t){return{ret:-1,filestat:null}}path_filestat_set_times(e,t,r,s,n){return-1}path_link(e,t,r,s){return-1}path_open(e,t,r,s,n,i){return{ret:-1,fd_obj:null}}path_readlink(e){return{ret:-1,data:null}}path_remove_directory(e){return-1}path_rename(e,t,r){return-1}path_symlink(e,t){return-1}path_unlink_file(e){return-1}}class i extends n{fd_fdstat_get(){return{ret:0,fdstat:new r(4,0)}}fd_read(e,t){let r=0;for(let s of t){if(!(this.file_pos<this.file.data.byteLength))break;{let t=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(s.buf_len)));e.set(t,s.buf),this.file_pos+=BigInt(t.length),r+=t.length}}return{ret:0,nread:r}}fd_seek(e,t){let r;switch(t){case 0:r=e;break;case 1:r=this.file_pos+e;break;case 2:r=BigInt(this.file.data.byteLength)+e;break;default:return{ret:28,offset:0n}}return r<0?{ret:28,offset:0n}:(this.file_pos=r,{ret:0,offset:this.file_pos})}fd_write(e,t){let r=0;if(this.file.readonly)return{ret:8,nwritten:r};for(let s of t){let t=e.slice(s.buf,s.buf+s.buf_len);if(this.file_pos+BigInt(t.byteLength)>this.file.size){let e=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(t.byteLength))),this.file.data.set(e)}this.file.data.set(t.slice(0,Number(this.file.size-this.file_pos)),Number(this.file_pos)),this.file_pos+=BigInt(t.byteLength),r+=s.buf_len}return{ret:0,nwritten:r}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}constructor(e){super(),this.file_pos=0n,this.file=e}}class f{open(e){let t=new i(this);return 1&e&&t.fd_seek(0n,2),t}get size(){return BigInt(this.data.byteLength)}stat(){return new s(4,this.size)}truncate(){return this.readonly?63:(this.data=new Uint8Array([]),0)}constructor(e,t){this.data=new Uint8Array(e),this.readonly=!!t?.readonly}}let l=class{start(e){this.inst=e,e.exports._start()}initialize(e){this.inst=e,e.exports._initialize()}constructor(r,s,n){this.args=[],this.env=[],this.fds=[],this.args=r,this.env=s,this.fds=n;let i=this;this.wasiImport={args_sizes_get(e,t){let r=new DataView(i.inst.exports.memory.buffer);r.setUint32(e,i.args.length,!0);let s=0;for(let e of i.args)s+=e.length+1;return r.setUint32(t,s,!0),0},args_get(e,t){let r=new DataView(i.inst.exports.memory.buffer),s=new Uint8Array(i.inst.exports.memory.buffer);for(let n=0;n<i.args.length;n++){r.setUint32(e,t,!0),e+=4;let f=new TextEncoder("utf-8").encode(i.args[n]);s.set(f,t),r.setUint8(t+f.length,0),t+=f.length+1}return 0},environ_sizes_get(e,t){let r=new DataView(i.inst.exports.memory.buffer);r.setUint32(e,i.env.length,!0);let s=0;for(let e of i.env)s+=e.length+1;return r.setUint32(t,s,!0),0},environ_get(e,t){let r=new DataView(i.inst.exports.memory.buffer),n=new Uint8Array(i.inst.exports.memory.buffer);for(let i=0;i<s.length;i++){r.setUint32(e,t,!0),e+=4;let f=new TextEncoder("utf-8").encode(s[i]);n.set(f,t),r.setUint8(t+f.length,0),t+=f.length+1}return 0},clock_res_get(e,t){throw"unimplemented"},clock_time_get(e,t,r){let s=new DataView(i.inst.exports.memory.buffer);if(0===e)s.setBigUint64(r,1000000n*BigInt((new Date).getTime()),!0);else if(1==e){let e;try{e=BigInt(Math.round(1e6*performance.now()))}catch(t){e=0n}s.setBigUint64(r,e,!0)}else s.setBigUint64(r,0n,!0);return 0},fd_advise:(e,t,r,s)=>null!=i.fds[e]?i.fds[e].fd_advise(t,r,s):8,fd_allocate:(e,t,r)=>null!=i.fds[e]?i.fds[e].fd_allocate(t,r):8,fd_close(e){if(null!=i.fds[e]){let t=i.fds[e].fd_close();return i.fds[e]=void 0,t}return 8},fd_datasync:e=>null!=i.fds[e]?i.fds[e].fd_datasync():8,fd_fdstat_get(e,t){if(null!=i.fds[e]){let{ret:r,fdstat:s}=i.fds[e].fd_fdstat_get();return null!=s&&s.write_bytes(new DataView(i.inst.exports.memory.buffer),t),r}return 8},fd_fdstat_set_flags:(e,t)=>null!=i.fds[e]?i.fds[e].fd_fdstat_set_flags(t):8,fd_fdstat_set_rights:(e,t,r)=>null!=i.fds[e]?i.fds[e].fd_fdstat_set_rights(t,r):8,fd_filestat_get(e,t){if(null!=i.fds[e]){let{ret:r,filestat:s}=i.fds[e].fd_filestat_get();return null!=s&&s.write_bytes(new DataView(i.inst.exports.memory.buffer),t),r}return 8},fd_filestat_set_size:(e,t)=>null!=i.fds[e]?i.fds[e].fd_filestat_set_size(t):8,fd_filestat_set_times:(e,t,r,s)=>null!=i.fds[e]?i.fds[e].fd_filestat_set_times(t,r,s):8,fd_pread(t,r,s,n,f){let l=new DataView(i.inst.exports.memory.buffer),a=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[t]){let d=e.read_bytes_array(l,r,s),{ret:_,nread:u}=i.fds[t].fd_pread(a,d,n);return l.setUint32(f,u,!0),_}return 8},fd_prestat_get(e,t){let r=new DataView(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let{ret:s,prestat:n}=i.fds[e].fd_prestat_get();return null!=n&&n.write_bytes(r,t),s}return 8},fd_prestat_dir_name(e,t,r){if(null!=i.fds[e]){let{ret:r,prestat_dir_name:s}=i.fds[e].fd_prestat_dir_name();return null!=s&&new Uint8Array(i.inst.exports.memory.buffer).set(s,t),r}return 8},fd_pwrite(e,r,s,n,f){let l=new DataView(i.inst.exports.memory.buffer),a=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let d=t.read_bytes_array(l,r,s),{ret:_,nwritten:u}=i.fds[e].fd_pwrite(a,d,n);return l.setUint32(f,u,!0),_}return 8},fd_read(t,r,s,n){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[t]){let a=e.read_bytes_array(f,r,s),{ret:d,nread:_}=i.fds[t].fd_read(l,a);return f.setUint32(n,_,!0),d}return 8},fd_readdir(e,t,r,s,n){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let a=0;for(;;){let{ret:d,dirent:_}=i.fds[e].fd_readdir_single(s);if(0!=d)return f.setUint32(n,a,!0),d;if(null==_)break;if(r-a<_.head_length()){a=r;break}let u=new ArrayBuffer(_.head_length());if(_.write_head_bytes(new DataView(u),0),l.set(new Uint8Array(u).slice(0,Math.min(u.byteLength,r-a)),t),t+=_.head_length(),a+=_.head_length(),r-a<_.name_length()){a=r;break}_.write_name_bytes(l,t,r-a),t+=_.name_length(),a+=_.name_length(),s=_.d_next}return f.setUint32(n,a,!0),0}return 8},fd_renumber(e,t){if(null!=i.fds[e]&&null!=i.fds[t]){let r=i.fds[t].fd_close();return 0!=r?r:(i.fds[t]=i.fds[e],i.fds[e]=void 0,0)}return 8},fd_seek(e,t,r,s){let n=new DataView(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let{ret:f,offset:l}=i.fds[e].fd_seek(t,r);return n.setBigInt64(s,l,!0),f}return 8},fd_sync:e=>null!=i.fds[e]?i.fds[e].fd_sync():8,fd_tell(e,t){let r=new DataView(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let{ret:s,offset:n}=i.fds[e].fd_tell();return r.setBigUint64(t,n,!0),s}return 8},fd_write(e,r,s,n){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let a=t.read_bytes_array(f,r,s),{ret:d,nwritten:_}=i.fds[e].fd_write(l,a);return f.setUint32(n,_,!0),d}return 8},path_create_directory(e,t,r){let s=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let n=new TextDecoder("utf-8").decode(s.slice(t,t+r));return i.fds[e].path_create_directory(n)}},path_filestat_get(e,t,r,s,n){let f=new DataView(i.inst.exports.memory.buffer),l=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let a=new TextDecoder("utf-8").decode(l.slice(r,r+s)),{ret:d,filestat:_}=i.fds[e].path_filestat_get(t,a);return null!=_&&_.write_bytes(f,n),d}return 8},path_filestat_set_times(e,t,r,s,n,f,l){let a=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let d=new TextDecoder("utf-8").decode(a.slice(r,r+s));return i.fds[e].path_filestat_set_times(t,d,n,f,l)}return 8},path_link(e,t,r,s,n,f,l){let a=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]&&null!=i.fds[n]){let d=new TextDecoder("utf-8").decode(a.slice(r,r+s)),_=new TextDecoder("utf-8").decode(a.slice(f,f+l));return i.fds[n].path_link(e,t,d,_)}return 8},path_open(e,t,r,s,n,f,l,a,d){let _=new DataView(i.inst.exports.memory.buffer),u=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let o=new TextDecoder("utf-8").decode(u.slice(r,r+s)),{ret:h,fd_obj:w}=i.fds[e].path_open(t,o,n,f,l,a);if(0!=h)return h;i.fds.push(w);let p=i.fds.length-1;return _.setUint32(d,p,!0),0}return 8},path_readlink(e,t,r,s,n,f){let l=new DataView(i.inst.exports.memory.buffer),a=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let d=new TextDecoder("utf-8").decode(a.slice(t,t+r)),{ret:_,data:u}=i.fds[e].path_readlink(d);if(null!=u){if(u.length>n)return l.setUint32(f,0,!0),8;a.set(u,s),l.setUint32(f,u.length,!0)}return _}return 8},path_remove_directory(e,t,r){let s=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let n=new TextDecoder("utf-8").decode(s.slice(t,t+r));return i.fds[e].path_remove_directory(n)}return 8},path_rename(e,t,r,s,n,i){throw"FIXME what is the best abstraction for this?"},path_symlink(e,t,r,s,n){let f=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[r]){let l=new TextDecoder("utf-8").decode(f.slice(e,e+t)),a=new TextDecoder("utf-8").decode(f.slice(s,s+n));return i.fds[r].path_symlink(l,a)}return 8},path_unlink_file(e,t,r){let s=new Uint8Array(i.inst.exports.memory.buffer);if(null!=i.fds[e]){let n=new TextDecoder("utf-8").decode(s.slice(t,t+r));return i.fds[e].path_unlink_file(n)}return 8},poll_oneoff(e,t,r){throw"async io not supported"},proc_exit(e){throw"exit with exit code "+e},proc_raise(e){throw"raised signal "+e},sched_yield(){},random_get(e,t){let r=new Uint8Array(i.inst.exports.memory.buffer);for(let s=0;s<t;s++)r[e+s]=256*Math.random()|0},sock_recv(e,t,r){throw"sockets not supported"},sock_send(e,t,r){throw"sockets not supported"},sock_shutdown(e,t){throw"sockets not supported"},sock_accept(e,t){throw"sockets not supported"}}}};window.startReactor=async function(e){const t=new i(new f([])),r=new i(new f([])),s=new i(new f([])),n=new l([],[],[t,r,s]),a=await WebAssembly.compileStreaming(fetch(e)),d=await WebAssembly.instantiate(a,{wasi_snapshot_preview1:n.wasiImport});return n.inst=d,d.exports.hs_init_with_sanity_checks(),n}})();